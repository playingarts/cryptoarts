name: Smoke Test

on:
  # Triggered by Vercel deployment webhook or manually
  repository_dispatch:
    types: [vercel-deployment]
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to test (defaults to dev.playingarts.com)'
        required: false
        default: 'https://dev.playingarts.com'

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      DEPLOYMENT_URL: ${{ github.event.client_payload.deployment_url || github.event.inputs.deployment_url || 'https://dev.playingarts.com' }}

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Test homepage returns 200
        run: |
          echo "Testing: $DEPLOYMENT_URL/"
          status=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/")
          if [ "$status" != "200" ]; then
            echo "‚ùå Homepage returned $status (expected 200)"
            exit 1
          fi
          echo "‚úÖ Homepage returned 200"

      - name: Test health endpoint returns 200
        run: |
          echo "Testing: $DEPLOYMENT_URL/api/health"
          response=$(curl -s "$DEPLOYMENT_URL/api/health")
          status=$(echo "$response" | jq -r '.status')

          if [ "$status" = "down" ]; then
            echo "‚ùå Health check failed: $response"
            exit 1
          fi

          echo "‚úÖ Health endpoint status: $status"
          echo "$response" | jq .

      - name: Test shop page returns 200
        run: |
          echo "Testing: $DEPLOYMENT_URL/shop"
          status=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/shop")
          if [ "$status" != "200" ]; then
            echo "‚ùå Shop page returned $status (expected 200)"
            exit 1
          fi
          echo "‚úÖ Shop page returned 200"

      - name: Test deck page returns 200
        run: |
          echo "Testing: $DEPLOYMENT_URL/crypto"
          status=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/crypto")
          if [ "$status" != "200" ]; then
            echo "‚ùå Deck page returned $status (expected 200)"
            exit 1
          fi
          echo "‚úÖ Deck page returned 200"

      - name: Test GraphQL endpoint
        run: |
          echo "Testing: $DEPLOYMENT_URL/api/v1/graphql"
          response=$(curl -s -X POST "$DEPLOYMENT_URL/api/v1/graphql" \
            -H "Content-Type: application/json" \
            -d '{"query":"{ __typename }"}')

          if echo "$response" | grep -q "errors"; then
            echo "‚ùå GraphQL returned errors: $response"
            exit 1
          fi
          echo "‚úÖ GraphQL endpoint working"

      - name: Summary
        if: always()
        run: |
          echo "üîç Smoke test completed for: $DEPLOYMENT_URL"
          echo "See job logs for detailed results"
